#!/bin/bash
set -e
set -o pipefail
export IBAMR_DIR=$PWD
export IBAMR_ARCH=build
export PETSC_DIR=$IBAMR_DIR/$IBAMR_ARCH/PETSC
export PETSC_ARCH=linux-debug

build_petsc() {
    mkdir -p $PETSC_DIR && git clone -b knepley/ibamr https://bitbucket.org/deleeke/petsc $PETSC_DIR
    cd $PETSC_DIR
    ./configure --download-openmpi --download-fblaslapack \
        --CC=$C_COMPILER --CXX=$CXX_COMPILER --FC=$FORTRAN_COMPILER \
        --with-clanguage=c++ --with-debugging=$DEBUG_OPTION
    make
}

config_ibamr(){
    cd $IBAMR_DIR
    ./configure.new \
    --with-mpi-dir=$PETSC_DIR/$PETSC_ARCH/ \
    --download-fblaslapack \
    --download-muparser \
    --download-samrai \
    --download-hdf5 \
    --download-silo \
    --download-eigen \
    --download-boost=$BOOST_TARBALL \
    --boost-headers-only \
    --download-libmesh \
    --with-clanguage=c++ \
    --with-debugging=$DEBUG_OPTION
}

rm -rf $IBAMR_ARCH
build_petsc
config_ibamr
make all
